# Komei Shimbun AI Transcriptor

## 概要
「Komei Shimbun AI Transcriptor」は、FastAPIを用いた音声テキスト起こしAPIサーバです。アップロードされた音声ファイルに対し、OpenAI Whisper APIを利用して効率的かつ高精度な文字起こしを実施します。プロジェクトでは、音声ファイルのバリデーション、必要に応じたMP3形式への変換、及び10分以上の音声ファイルに対する自動分割処理を実装しています。また、アプリケーション起動時には、指定ディレクトリ内の不要なファイルを自動的にクリーンアップし、安定した運用をサポートします。

## 主な機能
- **音声ファイルのアップロードと前処理**  
  ユーザーからの音声ファイルを受け取り、形式やサイズの検証、非MP3形式の場合のMP3への変換、及び10分以上の音声の場合の自動分割を実施します。

- **文字起こし処理**  
  OpenAI Whisper API（whisper-1モデル）を使用し、非同期処理により複数のファイルの文字起こしを並列で実行。分割ファイルの場合は、各セグメントの結果を統合し、タイムスタンプ付きのセグメントテキストとして提供します。

- **結果の保存とダウンロード**  
  文字起こし結果はユーザーごとに整理され、「transcription_results」ディレクトリに保存されます。専用のエンドポイントからファイルのダウンロードが可能です。

- **UI提供**  
  静的HTML（index.html）を返す「/ui」エンドポイントにより、利用者に対して簡易的なユーザーインターフェースを提供します。アクセス時にはファイルの自動クリーンアップも実施されます。

## 技術／アーキテクチャ
- **バックエンド**: FastAPIを利用した高速・効率的なAPIサーバ
- **非同期処理**: async/await構文を用いて、複数ファイルの文字起こし処理を並列に実行
- **データバリデーション**: Pydanticを用いたリクエスト/レスポンスのデータ検証
- **音声処理**: pydubライブラリを活用し、音声ファイルの読み込み、変換、分割、および長さの計測を実施
- **外部連携**: OpenAI Whisper APIにより高精度な文字起こしを実現
- **ファイル管理**: アップロードされたファイルはユーザーごとに整理され、処理済みファイルは「processed_audio」、文字起こし結果は「transcription_results」に格納
- **自動クリーンアップ**: サーバ起動時に、指定ディレクトリ内の一時ファイルや不要ファイルを自動的に削除

## API エンドポイント
- **POST /okoshi**  
  音声ファイルのアップロード、検証、保存、必要に応じた形式変換・分割、及びOpenAI Whisperによる文字起こし処理を実施します。

- **GET /download/transcription/{filename}**  
  文字起こし結果ファイルのダウンロードを提供します。ディレクトリトラバーサル防止対策が実装されています。

- **GET /ui**  
  静的HTML（index.html）を返すことで、利用者用の簡易UIを提供します。アクセス時にはファイルクリーンアップ処理も実行されます。

## ディレクトリ構成
- **api/**: FastAPIの主要ソースコード（エンドポイント、ルーティング、ユーティリティ）
  - **routers/**: 各エンドポイント（/okoshi、/uiなど）の実装
  - **schemas/**: Pydanticを用いたデータ検証モデル
  - **utils/**: 音声処理やWhisper API連携のためのユーティリティ
- **processed_audio/**: 処理済みの音声ファイルおよび一時ファイル（ユーザー別の保存、分割ファイルを含む）
- **transcription_results/**: 文字起こし結果ファイルの保存先
- **その他**: Docker関連ファイル（Dockerfile、docker-compose.yml、.dockerignore）および依存管理ファイル（pyproject.toml、poetry.lock）

## 注意点
- アップロードされる音声ファイルは、許可された形式（.m4a, .mp3, .webm, .mp4, .mpga, .wav, .mpeg, .wma）のみ対応しています。
- 非MP3ファイルは自動的にMP3形式に変換され、変換後は元のファイルが削除されます。
- 音声ファイルが10分（600秒）を超える場合、自動的に複数のセグメントに分割されます。
- サーバ起動時に、processed_audioおよびtranscription_resultsディレクトリの不要ファイルが自動的にクリーンアップされます。
- ファイルのアップロード、変換、分割、および文字起こし中にエラーが発生した場合、適切なエラーハンドリングが行われます。

## セットアップと実行方法
1. **依存関係のインストール**  
   Poetryを使用して、以下のコマンドで依存関係をインストールします:
   ```
   poetry install
   ```

2. **環境変数の設定**  
   プロジェクトルートに.envファイルを作成し、必要な環境変数（例: OPENAI_API_KEY）を設定してください。

3. **サーバの起動**  
   Docker Composeを使用する場合:
   ```
   docker-compose up --build
   ```
   または、直接FastAPIサーバを起動する場合:
   ```
   uvicorn api.main:app --host 0.0.0.0 --port 8000
